<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>倉庫訂餐網</title>
<style>
:root{--page-width:900px;--bg:#fff4ea}
body{background:var(--bg);font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans TC','Microsoft JhengHei',sans-serif;color:#333;margin:0;display:flex;min-height:100vh;align-items:flex-start;justify-content:center;padding:40px 20px}
.container{width:100%;max-width:var(--page-width);background:white;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.07);padding:24px;box-sizing:border-box}
h1{margin:0 0 12px;font-size:20px}
.row{display:flex;gap:12px;align-items:center;margin-bottom:12px}
label{min-width:84px}
input[type=text],input[type=number]{padding:8px;border-radius:6px;border:1px solid #ddd}
select{padding:8px;border-radius:6px;border:1px solid #ddd}
button{padding:8px 12px;border-radius:8px;border:0;background:#ff8a4b;color:#fff;cursor:pointer}
button.secondary{background:#ffb777;color:#000}
.center{display:flex;justify-content:center;gap:12px;margin:16px 0}
.menu-area{border:1px dashed #ffd3b8;padding:12px;border-radius:8px;background:#fff7f0}
.hidden{display:none}
</style>
</head>
<body>
<div class="container" role="application">
  <h1>倉庫訂餐網</h1>

  <!-- Login page -->
  <div id="page-login">
    <div class="row">
      <label for="empId">員工工號</label>
      <input id="empId" type="text" placeholder="輸入工號 (6碼)" />
    </div>
    <div class="center">
      <button id="btnLogin">登入</button>
    </div>
  </div>

  <!-- Home -->
  <div id="page-home" class="hidden">
    <p id="welcome"></p>
    <div class="center">
      <button id="toLunch">午餐</button>
      <button id="toDrinks" class="secondary">飲料</button>
    </div>
  </div>

  <!-- Lunch -->
  <div id="page-lunch" class="hidden">
    <div class="row">
      <label for="restaurant">餐廳名稱</label>
      <select id="restaurant"></select>
    </div>

    <div class="menu-area">
      <div class="row">
        <label>餐點選擇</label>
        <select id="menuItem"></select>
      </div>

      <!-- 額外選項 -->
      <div class="row hidden" id="additionalRow">
        <label>主食</label>
        <select id="potMain"></select>
      </div>

      <div class="row">
        <label>調味</label>
        <select id="spice">
          <option>不加</option>
          <option>微辣</option>
          <option>加醋</option>
        </select>
      </div>

      <div class="row">
        <label>數量</label>
        <input id="qty" type="number" min="1" value="1" style="width:70px" />
      </div>

      <div class="row">
        <label>備註</label>
        <input id="note" placeholder="例:少醬、不要蔥" />
      </div>

      <div class="center">
        <button id="addLunch">新增訂單（送出到團主）</button>
        <button id="backFromLunch" class="secondary">回上一頁</button>
      </div>
    </div>
  </div>

  <!-- Drinks -->
  <div id="page-drinks" class="hidden">
    <div class="row">
      <label>飲料店</label>
      <div class="drink-buttons">
        <button data-url="https://order.nidin.shop/gb/menu/2967/ImLfQ0aZSe">50嵐</button>
        <button data-url="https://order.didieats.com.tw/store/liketea0716?group_buy_no=20250006835">老賴茶坊</button>
      </div>
    </div>
    <div class="center">
      <button id="backFromDrinks" class="secondary">回上一頁</button>
    </div>
  </div>

  <!-- Orders -->
  <div class="orders">
    <h3>我的訂單（即時顯示）</h3>
    <div id="ordersList"></div>
    <p class="note">僅顯示你本人的訂單，可隨時刪除。</p>
  </div>
</div>

<script>
const GOOGLE_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzuZV7VtIXWtuaQGQV37pIz2g0E42WE6MY6jZJd1f1ht4E8zXqlDr8BifzV9QGfBHqd/exec";
let CURRENT_USER = null;
let MENUS = {};

const el = id => document.getElementById(id);
const restaurantSel = el("restaurant");
const menuItemSel = el("menuItem");
const potMainSel = el("potMain");

async function loadMenus() {
  try {
    const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getMenus`);
    MENUS = await res.json();
  } catch (e) {
    console.error("fetch menus failed", e);
    MENUS = {};
  }

  restaurantSel.innerHTML = "";
  Object.keys(MENUS).forEach(r => {
    const opt = document.createElement("option");
    opt.value = r;
    opt.textContent = r;
    restaurantSel.appendChild(opt);
  });
  if (restaurantSel.options.length > 0) {
    restaurantSel.selectedIndex = 0;
  }
  populateMenu(restaurantSel.value);
}

function populateMenu(restaurant) {
  menuItemSel.innerHTML = "";
  const items = MENUS[restaurant] || [];
  let lastCat = null;

  items.forEach(it => {
    if (it.cat !== lastCat) {
      const catOpt = document.createElement("option");
      catOpt.disabled = true;
      catOpt.textContent = it.cat;
      catOpt.style.fontWeight = "600";
      menuItemSel.appendChild(catOpt);
      lastCat = it.cat;
    }
    const option = document.createElement("option");
    option.value = JSON.stringify(it);
    option.textContent = `${it.name} — ${it.price}元`;
    menuItemSel.appendChild(option);
  });

  // 預設隱藏額外欄位
  const additionalRow = el("additionalRow");
  additionalRow.classList.add("hidden");
  potMainSel.innerHTML = "";
}

restaurantSel.addEventListener("change", () => {
  populateMenu(restaurantSel.value);
  el("qty").value = 1;
  el("note").value = "";
  el("spice").selectedIndex = 0;

  const additionalRow = el("additionalRow");
  additionalRow.classList.add("hidden");
  potMainSel.innerHTML = "";

  // 若為呷飽飽創意鍋燒 → 顯示主食
  if (restaurantSel.value.includes("呷飽飽創意鍋燒")) {
    showMainOptions();
  }
});

menuItemSel.addEventListener("change", () => {
  const restaurant = restaurantSel.value;
  const additionalRow = el("additionalRow");

  if (restaurant.includes("呷飽飽創意鍋燒")) {
    showMainOptions();
  } else {
    additionalRow.classList.add("hidden");
  }
});

function showMainOptions() {
  const additionalRow = el("additionalRow");
  const label = additionalRow.querySelector("label");
  label.textContent = "主食";
  potMainSel.innerHTML = `
    <option>意麵</option>
    <option>雞絲麵</option>
    <option>雞絲麵加麵</option>
    <option>烏龍麵</option>
    <option>烏龍麵加麵</option>
    <option>冬粉</option>
    <option>冬粉加麵</option>
    <option>蒸煮麵</option>
    <option>蒸煮麵加麵</option>
    <option>蛋黃麵</option>
    <option>蛋黃麵加麵</option>
    <option>香Q麵</option>
    <option>香Q麵加麵</option>
    <option>綠藻麵</option>
    <option>綠藻麵加麵</option>
    <option>麵疙瘩</option>
    <option>麵疙瘩加麵</option>
  `;
  additionalRow.classList.remove("hidden");
}

// 登入
el("btnLogin").addEventListener("click", async () => {
  const empId = el("empId").value.trim();
  try {
    const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getEmployees`);
    const employees = await res.json();
    const found = employees.find(e => String(e.id) === empId);
    if (found) {
      CURRENT_USER = found;
      el("page-login").classList.add("hidden");
      el("page-home").classList.remove("hidden");
      el("welcome").textContent = `歡迎 ${found.name}`;
      loadMenus();
      renderOrders();
    } else {
      alert("工號不存在");
    }
  } catch (e) {
    alert("登入失敗");
    console.error(e);
  }
});

// 新增訂單
el("addLunch").addEventListener("click", async () => {
  const date = new Date().toISOString().slice(0, 10);
  const restaurant = restaurantSel.value;
  const itemObj = JSON.parse(menuItemSel.value || "{}");
  if (!itemObj.name) return alert("請選擇餐點");

  const params = new URLSearchParams();
  params.append("date", date);
  params.append("employee", CURRENT_USER.name);
  params.append("restaurant", restaurant);
  params.append("item", itemObj.name);
  params.append("price", itemObj.price || "");
  params.append("spice", el("spice").value);
  params.append("qty", el("qty").value);
  params.append("note", el("note").value);
  params.append("potMain", el("potMain").value || "");

  try {
    const res = await fetch(GOOGLE_WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: params,
    });
    await res.json();
    alert("訂單已新增");
    renderOrders();
  } catch (e) {
    alert("新增訂單失敗");
  }
});

// 訂單清單
async function renderOrders() {
  const ordersList = el("ordersList");
  if (!CURRENT_USER) return;
  try {
    const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getOrders&employee=${encodeURIComponent(CURRENT_USER.name)}`);
    const data = await res.json();
    ordersList.innerHTML = "";
    data.forEach((o, idx) => {
      const div = document.createElement("div");
      div.className = "order-item";
      div.innerHTML = `
        <strong>#${idx + 1} ${o.restaurant} - ${o.item}</strong>
        <div class="small">日期: ${o.date} | 員工: ${o.employee} | 數量: ${o.qty} | 價格: ${o.price} 元 | 調味: ${o.spice}</div>
        <div class="small">備註: ${o.note || ""} ${o.potMain ? " | 主食: " + o.potMain : ""}</div>
        <button class="delete-btn" data-id="${o.id}">刪除</button>
      `;
      ordersList.appendChild(div);
    });
    document.querySelectorAll(".delete-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        if (confirm("確定要刪除此筆訂單嗎？")) {
          const params = new URLSearchParams();
          params.append("action", "delete");
          params.append("id", btn.dataset.id);
          params.append("employee", CURRENT_USER.name);
          await fetch(GOOGLE_WEBAPP_URL, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: params,
          });
          renderOrders();
        }
      });
    });
  } catch (e) {
    console.error("renderOrders error", e);
  }
}

// 導覽
el("toLunch").addEventListener("click", () => {
  el("page-home").classList.add("hidden");
  el("page-lunch").classList.remove("hidden");
});
el("toDrinks").addEventListener("click", () => {
  el("page-home").classList.add("hidden");
  el("page-drinks").classList.remove("hidden");
});
el("backFromLunch").addEventListener("click", () => {
  el("page-lunch").classList.add("hidden");
  el("page-home").classList.remove("hidden");
});
el("backFromDrinks").addEventListener("click", () => {
  el("page-drinks").classList.add("hidden");
  el("page-home").classList.remove("hidden");
});

document.querySelectorAll(".drink-buttons button").forEach(btn => {
  btn.addEventListener("click", () => {
    const url = btn.dataset.url;
    if (!url) return alert("此店網址尚未提供");
    window.open(url, "_blank");
  });
});
</script>
</body>
</html>
